<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Tag: nginx - lawilet&#039;s website</title><meta property="og:type" content="blog"><meta property="og:title" content="lawilet&#039;s website"><meta property="og:url" content="http://law-liet.com/"><meta property="og:site_name" content="lawilet&#039;s website"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://law-liet.com/img/og_image.png"><meta property="article:author" content="lawiet019"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://law-liet.com"},"headline":"lawilet's website","image":["http://law-liet.com/img/og_image.png"],"author":{"@type":"Person","name":"lawiet019"},"description":""}</script><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="lawilet&#039;s website" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/lawiet019"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">nginx</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-15T19:03:00.000Z" title="2021-09-15T19:03:00.000Z">2021-09-15</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">6 minutes read (About 930 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/15/notes-of-nginx-learning-11/">notes of nginx learning (11)</a></h1><div class="content"><ul>
<li><strong>what is Load Balance</strong></li>
</ul>
<p>Efficiently distributing incoming network traffic across a group of backend servers, also known as a server farm or server pool.</p>
<p>The mechanism can be seen as<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">     request</span><br><span class="line">user -------&gt; load balancer ------&gt; server 1</span><br><span class="line">     &lt;-------               ------&gt; server 2</span><br><span class="line">     response               ------&gt; server 3</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Some directives we may use for load Balance</strong></li>
</ul>
<p><code>upstream name { ... }</code><br><code>server address [parameters];</code><br><code>keepalive connections;</code><br><code>keepalive_requests number;</code><br><code>keepalive_timeout</code><br><code>queue</code></p>
<ul>
<li><strong>how to realize the load balancer in nginx</strong></li>
</ul>
<p>Firstly, let we create a file named <code>loadbalancer.conf</code>(we will include it in <code>nginx.conf</code>)<br>The file looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">upstream servers &#123;</span><br><span class="line">  server 127.0.0.1:8021 weight&#x3D;20;</span><br><span class="line">  server 127.0.0.1:8022 weight&#x3D;5;</span><br><span class="line">  server 127.0.0.1:8023 weight&#x3D;1 ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 8080;</span><br><span class="line">  server_name localhost;</span><br><span class="line">  location &#x2F;loadbalancer &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;servers;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 8021;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    return 200 &#39;the port is 8021&#39;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 8022;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    return 200 &#39;the port is 8022&#39;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 8023;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    return 200 &#39;the port is 8023&#39;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>After reloading the configuration file,  we could use <code>curl localhost:8080/loadbalancer</code> to test the change. We could see that <code>the port is 8021</code> appears most, followed by <code>the port is 8022</code> because of the weight we set.</p>
<ul>
<li><strong>load balance algorithm  - round robin</strong></li>
</ul>
<p>Round Robin – Requests are distributed evenly across the servers, with server weights taken into consideration. This method is used by default.<br>The example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream servers &#123;</span><br><span class="line">  server 127.0.0.1:8021 weight&#x3D;20;</span><br><span class="line">  server 127.0.0.1:8022 weight&#x3D;5;</span><br><span class="line">  server 127.0.0.1:8023 weight&#x3D;1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><strong>load balance algorithm  - hash algorithm</strong></p>
<ul>
<li>what is hash function</li>
</ul>
<p>A hash function is any function that can be used to map data of arbitrary size to fixed-size values. And it is irreversible</p>
<p>The most important thing about hashing is that:</p>
<ol>
<li>The same input must yield the same output;</li>
<li>Different inputs are likely to produce different outputs</li>
</ol>
<p>The purpose of a hash algorithm is to verify that the original data has not been tampered with</p>
<ul>
<li>directive used in load balance algorithm based on hashing.</li>
</ul>
<ol>
<li><code>hash</code></li>
</ol>
<p><code>hash key [consistent];</code><br>Specifies a load balancing method for a server group where the client-server mapping is based on the hashed key value.The key can contain text, variables, and their combinations. Note that adding or removing a server from the group may result in remapping most of the keys to different servers.<br>Context:    upstream</p>
<ol>
<li><code>ip_hash</code></li>
</ol>
<p><code>ip_hash;</code></p>
<p>Specifies that a group should use a load balancing method where requests are distributed between servers based on client IP addresses. The first three octets of the client IPv4 address, or the entire IPv6 address, are used as a hashing key. The method ensures that requests from the same client will always be passed to the same server except when this server is unavailable.<br>Context:    upstream</p>
<ul>
<li>to implement the load balance algorithm in nginx</li>
</ul>
<p>Firstly, let we create a file named <code>balance_hash.conf</code>(we will include it in <code>nginx.conf</code>)<br>The file looks like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">  server 127.0.0.1:8081;</span><br><span class="line">  server 127.0.0.1:8082;</span><br><span class="line">  hash $request_uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 8080;</span><br><span class="line">  server_name localhost;</span><br><span class="line">  location &#x2F;hash &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 8081;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    return 200 &#39;it listens on port 8081&#39;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 8082;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    return 200 &#39;it listens on port 8082&#39;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this file, we use <code>$request_uri</code> as the key for hashing. And we could test like <code>curl localhost:8080/hash/apple.html</code>  or <code>curl localhost:8080/hash/test.html</code> to see whether the same url will be handled by the same server.</p>
</li>
<li><p><strong>load balance algorithm - Least Connections</strong></p>
<p>A request is sent to the server with the least number of active connections, again with server weights taken into consideration:<br>example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> upstream backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    server backend1.example.com;</span><br><span class="line">    server backend2.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>fault-tolerant mechanism in load balancer</strong></p>
</li>
</ul>
<p>When one backend server doesn’t give expected result to nginx, it will send the request to another server.<br>Here are some directives we may use.</p>
<ol>
<li><code>proxy_next_upstream</code></li>
</ol>
<p><code>proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | off ...;</code><br>Default:    <code>proxy_next_upstream error timeout;</code><br>Context:    http, server, location</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>parameter</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>error</td>
<td>an error occurred while establishing a connection with the server, passing a request to it, or reading the response header;</td>
</tr>
<tr>
<td>timeout</td>
<td>a timeout has occurred while establishing a connection with the server, passing a request to it, or reading the response header;</td>
</tr>
<tr>
<td>invalid_header</td>
<td>a server returned an empty or invalid response;</td>
</tr>
<tr>
<td>http_500</td>
<td>a server returned a response with the code 500;</td>
</tr>
<tr>
<td>http_502</td>
<td>a server returned a response with the code 502;</td>
</tr>
<tr>
<td>http_503</td>
<td>a server returned a response with the code 503;</td>
</tr>
<tr>
<td>http_504</td>
<td>a server returned a response with the code 504;</td>
</tr>
<tr>
<td>http_403</td>
<td>a server returned a response with the code 403;</td>
</tr>
<tr>
<td>http_404</td>
<td>a server returned a response with the code 404;</td>
</tr>
<tr>
<td>http_429</td>
<td>a server returned a response with the code 429;</td>
</tr>
<tr>
<td>non_idempotent</td>
<td>normally, requests with a non-idempotent method (POST, LOCK, PATCH) are not passed to the next server if a request has been sent to an upstream server (1.9.13); enabling this option explicitly allows retrying such requests;</td>
</tr>
<tr>
<td>off</td>
<td>disables passing a request to the next server.</td>
</tr>
</tbody>
</table>
</div>
<p>For example<br><code>proxy_next_upstream error timeout http_500;</code></p>
<ol>
<li><code>proxy_next_upstream_timeout</code></li>
</ol>
<p><code>proxy_next_upstream_timeout time;</code><br>Limits the time during which a request can be passed to the next server. The 0 value turns off this limitation.<br>Default:    <code>proxy_next_upstream_timeout 0;</code><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_next_upstream_tries</code></li>
</ol>
<p><code>proxy_next_upstream_tries number;</code><br>Limits the number of possible tries for passing a request to the next server. The 0 value turns off this limitation.<br>Default:    <code>proxy_next_upstream_tries 0;</code><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_intercept_errors</code></li>
</ol>
<p><code>proxy_intercept_errors on | off;</code><br>Determines whether proxied responses with codes greater than or equal to 300 should be passed to a client or be intercepted and redirected to nginx for processing with the error_page directive.<br>If you have set proxy_next_upstream, it will not work.<br>Default:    <code>proxy_intercept_errors off;</code><br>Context:    http, server, location</p>
<ul>
<li><strong>reference</strong><br><a href="https://nginx.org/en/docs/dirindex.html">https://nginx.org/en/docs/dirindex.html</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-15T19:00:00.000Z" title="2021-09-15T19:00:00.000Z">2021-09-15</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">17 minutes read (About 2530 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/15/notes-of-nginx-learning-10/">notes of nginx learning (10)</a></h1><div class="content"><ul>
<li><strong>what is Reverse proxy server</strong></li>
</ul>
<ol>
<li>what is Reverse proxy server</li>
</ol>
<p>The reverse proxy server is located between the user and the actual server and provides a relay service for requests and responses.<br>For the user, access to the reverse proxy server is access to the actual server.<br>Reverse proxy can reduce server load consumption and increase efficiency</p>
<ol>
<li>the advantages of reverse proxy server<ul>
<li>hide the actual server</li>
<li>Horizontal expansion of back-end dynamic services</li>
<li>Separation of dynamic resources and static resources to improve system robustness</li>
</ul>
</li>
</ol>
<ul>
<li><strong>Dynamic and Static Separation</strong></li>
</ul>
<p>Deploy static website resources (HTML, JavaScript, CSS, img, etc.) separately from backend applications to improve the speed of user access to static code and reduce access to backend applications<br>One approach is to deploy the static resources on nginx(sometimes we could put static resources on CDN), and the backend project to the application server.</p>
<ul>
<li><strong>Supported protocols when using Nginx as a reverse proxy</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># transportation layer</span><br><span class="line">client-----&gt; nginx -----&gt; server</span><br><span class="line">      tcp           tcp</span><br><span class="line">      udp           udp</span><br><span class="line"></span><br><span class="line">client-----&gt; nginx -----&gt; server</span><br><span class="line">      http         fastcgi</span><br><span class="line">                   scgi</span><br><span class="line">                   uwsgi</span><br><span class="line">                   http</span><br><span class="line">                   grpc</span><br><span class="line">                   memcached</span><br><span class="line">                   websocket</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Look into module ngx_http_upstream_module</strong></li>
</ul>
<p>The ngx_http_upstream_module module is used to define groups of servers that can be referenced by the <code>proxy_pass</code>, <code>fastcgi_pass</code>, <code>uwsgi_pass</code>, <code>scgi_pass</code>, <code>memcached_pass</code>, and <code>grpc_pass directives</code>.</p>
<p>By default, the nginx is compiled with <code>http_upstream_module</code> . If we don’t want that, we need to use <code>--without-http_upstream_module</code>.</p>
<p>Let us look at directives</p>
<ol>
<li><code>upstream</code></li>
</ol>
<p><code>upstream name { ... }</code><br>Defines a group of servers in a block. Servers can listen on different ports. In addition, servers listening on TCP and UNIX-domain sockets can be mixed.<br>Context:    http<br>Here is the example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com weight&#x3D;5;</span><br><span class="line">    server 127.0.0.1:8080       max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">    server unix:&#x2F;tmp&#x2F;backend3;</span><br><span class="line"></span><br><span class="line">    server backup1.example.com  backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><code>server</code></li>
</ol>
<p><code>server address [parameters];</code><br>Defines the address and other parameters of a server. The address can be specified as a domain name or IP address, with an optional port, or as a UNIX-domain socket path specified after the “unix:” prefix. If a port is not specified, the port 80 is used. A domain name that resolves to several IP addresses defines multiple servers at once.<br>Context:    upstream</p>
<p>Here is the parameters</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>parameter</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>weight=number</td>
<td>sets the weight of the server, by default, 1. The weight is larger, the nginx will giver more requests to the server</td>
</tr>
<tr>
<td>max_conns=number</td>
<td>limits the maximum number of simultaneous active connections to the proxied server.Default value is zero, meaning there is no limit. If the server group does not reside in the shared memory, the limitation works per each worker process.</td>
</tr>
<tr>
<td>max_fails=number</td>
<td>sets the number of unsuccessful attempts to communicate with the server that should happen in the duration set by the fail_timeout parameter to consider the server unavailable for a duration also set by the fail_timeout parameter.</td>
</tr>
<tr>
<td>fail_timeout=time</td>
<td>the time during which the specified number of unsuccessful attempts to communicate with the server should happen to consider the server unavailable; and the period of time the server will be considered unavailable.</td>
</tr>
</tbody>
</table>
</div>
<p>By default, the parameter is set to 10 seconds|<br>|backup|marks the server as a backup server. It will be passed requests when the primary servers are unavailable.|<br>|down|marks the server as a backup server. It will be passed requests when the primary servers are unavailable.|<br>|resolve|monitors changes of the IP addresses that correspond to a domain name of the server, and automatically modifies the upstream configuration without the need of restarting nginx (1.5.12). The server group must reside in the shared memory. In order for this parameter to work, the resolver directive must be specified in the http block or in the corresponding upstream block.|<br>|route=string|sets the server route name.|<br>|service=name|enables resolving of DNS SRV records and sets the service name (1.9.13). In order for this parameter to work, it is necessary to specify the resolve parameter for the server and specify a hostname without a port number.|<br>|slow_start=time|sets the time during which the server will recover its weight from zero to a nominal value, when unhealthy server becomes healthy, or when the server becomes available after a period of time it was considered unavailable. Default value is zero, i.e. slow start is disabled.|<br>|drain|puts the server into the “draining” mode (1.13.6). In this mode, only requests bound to the server will be proxied to it.|</p>
<ol>
<li><code>zone</code></li>
</ol>
<p><code>zone name [size];</code><br>Defines the name and size of the shared memory zone that keeps the group’s configuration and run-time state that are shared between worker processes. Several groups may share the same zone. In this case, it is enough to specify the size only once.<br>Context:    upstream</p>
<ol>
<li><code>keepalive</code></li>
</ol>
<p><code>keepalive connections;</code><br>The connections parameter sets the maximum number of idle keepalive connections to upstream servers that are preserved in the cache of each worker process. When this number is exceeded, the least recently used connections are closed.<br>Context:    upstream<br>For example:<br><code>keepalive 32</code></p>
<ol>
<li><code>keepalive_requests</code></li>
</ol>
<p><code>keepalive_requests number</code><br>Sets the maximum number of requests that can be served through one keepalive connection. After the maximum number of requests is made, the connection is closed.<br>Default:    <code>keepalive_requests 1000;</code><br>Context:    upstream</p>
<ol>
<li><code>keepalive_timeout</code></li>
</ol>
<p><code>keepalive_timeout timeout;</code><br>Sets a timeout during which an idle keepalive connection to an upstream server will stay open.<br>Default:    <code>keepalive_timeout 60s;</code><br>Context:    upstream</p>
<p>And some other directives are related to load balance.<br><code>hash</code>,<code>ip_hash</code>,<code>least_conn</code>,<code>least_time</code>,<code>random</code>.  We will talk about it later.</p>
<ol>
<li><code>queue</code>[in commercial version only ]</li>
</ol>
<p><code>queue number [timeout=time];</code><br>If an upstream server cannot be selected immediately while processing a request, the request will be placed into the queue. The directive specifies the maximum number of requests that can be in the queue at the same time.<br>Context:    upstream<br>For example:<br><code>queue 100 timeout =30s</code></p>
<ul>
<li><strong>Look into proxy_pass directive</strong></li>
</ul>
<p><code>proxy_pass</code> is in <code>ngx_http_proxy_module</code> module<br>The ngx_http_proxy_module module allows passing requests to another server.<br>By default, it is compiled with <code>ngx_http_proxy_module</code>.If we don’t want to use the module <code>--without-ngx_http_proxy_module</code></p>
<p><code>proxy_pass URL;</code><br>Context:    location, if in location, limit_except<br>Sets the protocol and address of a proxied server and an optional URI to which a location should be mapped. As a protocol, “http” or “https” can be specified. The address can be specified as a domain name or IP address, and an optional port:</p>
<p><code>proxy_pass http://localhost:8000/uri/;</code><br>or as a UNIX-domain socket path specified after the word “unix” and enclosed in colons:</p>
<p><code>proxy_pass http://unix:/tmp/backend.socket:/uri/;</code><br>If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a server group.</p>
<p>Let us look at the difference between URL ends with <code>/</code> and without <code>/</code></p>
<p>If the url ends without <code>/</code>,nginx will modify the url by deleting the location url in proxy url.<br>If the url ends without <code>/</code>,nginx will not modify the URL and directly send it to upstream server.</p>
<p>For example,<br>if users use url <code>bbs/abc/test.html</code>,<br>if the config file is<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;bbs&#x2F;&#123;</span><br><span class="line">  proxy_pass http:&#x2F;&#x2F;127.0.0.1:8000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>the url arrive at upstream server will be <code>bbs/abc/test.html</code>.</p>
<p>if the config file is<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;bbs&#x2F;&#123;</span><br><span class="line">  proxy_pass http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>the url arrive at upstream server will be <code>abc/test.html</code>.</p>
<ul>
<li><strong>An example of reverse proxy by nginx</strong></li>
</ul>
<p>I don’t want to directly change the <code>nginx.conf</code> every time.  let us introduce a directive <code>include</code></p>
<p><code>include file | mask;</code><br>Includes another file, or files matching the specified mask, into configuration. Included files should consist of syntactically correct directives and blocks.<br>Context:    any</p>
<p>So to create a  new server block, we just need a include directive in <code>nginx.conf</code> like <code>include servers/*.conf;</code>. So every time we want to create a new server, we only need to create a file in servers.</p>
<p>create a file named <code>proxy.conf</code> in server folder</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    # the server can provide function</span><br><span class="line">    server 127.0.0.1:8000;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 8081;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location &#x2F;helloworld &#123;</span><br><span class="line">      proxy_pass http:&#x2F;&#x2F;backend&#x2F;v1&#x2F;users&#x2F;helloworld;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice: we may need to add backend to allow_hosts in django(since the url is provided by django). Or we will face error <code>Invalid HTTP_HOST header: &#39;backend&#39;</code></p>
<p>Then we could visit <code>localhost:8081/helloworld</code></p>
<ul>
<li><strong>Some directives related to proxy</strong></li>
</ul>
<ol>
<li><code>proxy_request_buffering</code></li>
</ol>
<p><code>proxy_request_buffering on | off;</code><br>Enables or disables buffering of a client request body.</p>
<p>When buffering is enabled, the entire request body is read from the client before sending the request to a proxied server. It meets  the high throughput requirements and it is suitable when the concurrent processing capability of upstream services is low</p>
<p>When buffering is disabled, the request body is sent to the proxied server immediately as it is received. In this case, the request cannot be passed to the next server if nginx already started sending the request body. It will reduce the responses time and save disk space.</p>
<p>When HTTP/1.1 chunked transfer encoding is used to send the original request body, the request body will be buffered regardless of the directive value unless HTTP/1.1 is enabled for proxying.<br>Default:    <code>proxy_request_buffering on;</code><br>Context:    http, server, location</p>
<ol>
<li><code>client_max_body_size</code></li>
</ol>
<p><code>client_max_body_size size;</code><br>Sets the maximum allowed size of the client request body. If the size in a request exceeds the configured value, the 413 (Request Entity Too Large) error is returned to the client. Please be aware that browsers cannot correctly display this error. Setting size to 0 disables checking of client request body size.<br>Default:    <code>client_max_body_size 1m;</code><br>Context:    http, server, location</p>
<ol>
<li><code>client_body_buffer_size</code></li>
</ol>
<p><code>client_body_buffer_size size;</code><br>Sets buffer size for reading client request body. In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file(defined by <code>client_body_temp_path</code>). By default, buffer size is equal to two memory pages. This is 8K on x86, other 32-bit platforms, and x86-64. It is usually 16K on other 64-bit platforms.</p>
<p>Default:    <code>client_body_buffer_size 8k|16k;</code><br>Context:    http, server, location</p>
<ol>
<li><code>client_body_temp_path</code></li>
</ol>
<p><code>client_body_temp_path path [level1 [level2 [level3]]]</code>;<br>Default:    <code>client_body_temp_path client_body_temp;</code><br>Context:    http, server, location<br>Defines a directory for storing temporary files holding client request bodies. Up to three-level subdirectory hierarchy can be used under the specified directory. For example, in the following configuration</p>
<p><code>client_body_temp_path /spool/nginx/client_temp 1 2;</code></p>
<p>a path to a temporary file might look like this:</p>
<p><code>/spool/nginx/client_temp/7/45/00000123457</code></p>
<p>Here, if there are values ​​for level1,2,3, it means that there are subdirectories at level 1, level 2, and level 3.<br>Directory names are named by numbers, so the specific value here is the number of digits representing the directory name</p>
<ol>
<li><code>client_body_in_single_buffer</code></li>
</ol>
<p><code>client_body_in_single_buffer on | off;</code><br>Determines whether nginx should save the entire client request body in a single buffer. The directive is recommended when using the $request_body variable, to save the number of copy operations involved.<br>Default:    <code>client_body_in_single_buffer off;</code><br>Context:    http, server, location</p>
<ol>
<li><code>client_body_in_file_only</code></li>
</ol>
<p><code>client_body_in_file_only on | clean | off;</code></p>
<p>Determines whether nginx should save the entire client request body into a file. This directive can be used during debugging, or when using the <code>$request_body_file</code> variable, or the <code>$r-&gt;request_body_file</code> method of the module ngx_http_perl_module.<br>When set to the value on, temporary files are not removed after request processing.<br>The value clean will cause the temporary files left after request processing to be removed.</p>
<p>Default:    <code>client_body_in_file_only off;</code><br>Context:    http, server, location</p>
<ol>
<li><code>client_body_timeout</code></li>
</ol>
<p><code>client_body_timeout time;</code><br>Default:    <code>client_body_timeout 60s;</code><br>Context:    http, server, location<br>Defines a timeout for reading client request body. The timeout is set only for a period between two successive read operations, not for the transmission of the whole request body. If a client does not transmit anything within this time, the request is terminated with the 408 (Request Time-out) error.</p>
<ul>
<li><strong>How does nginx change the request message sent upstream server when we use nginx for revese proxy</strong></li>
</ul>
<p>Look at some directives may work</p>
<ol>
<li><code>proxy_method</code></li>
</ol>
<p><code>proxy_method method;</code><br>Specifies the HTTP method to use in requests forwarded to the proxied server instead of the method from the client request. Parameter value can contain variables (1.11.6).<br>Context:    http, server, location</p>
<ol>
<li><code>proxy_http_version</code></li>
</ol>
<p><code>proxy_http_version 1.0 | 1.1;</code><br>Sets the HTTP protocol version for proxying. By default, version 1.0 is used. Version 1.1 is recommended for use with keepalive connections and NTLM authentication.<br>Default:    <code>proxy_http_version 1.0;</code><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_set_header</code></li>
</ol>
<p><code>proxy_set_header field value;</code><br>Allows redefining or appending fields to the request header passed to the proxied server.<br>Default:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Host $proxy_host;&#96;</span><br><span class="line">proxy_set_header Connection close;</span><br></pre></td></tr></table></figure><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_pass_request_headers</code></li>
</ol>
<p><code>proxy_pass_request_headers on | off;</code><br>Indicates whether the header fields of the original request are passed to the proxied server.<br>Default:    <code>proxy_pass_request_headers on;</code><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_set_body</code></li>
</ol>
<p><code>proxy_set_body value;</code><br>Allows redefining the request body passed to the proxied server. The value can contain text, variables, and their combination.<br>Context:    http, server, location</p>
<ol>
<li><code>proxy_pass_request_body</code></li>
</ol>
<p><code>proxy_pass_request_body on | off;</code><br>Default:    <code>proxy_pass_request_body on;</code><br>Context:    http, server, location<br>Indicates whether the original request body is passed to the proxied server.</p>
<ul>
<li><strong>Details of establishing a connection between Nginx and upstream server in a proxy scenario</strong></li>
</ul>
<p>Let we look at some directives</p>
<ol>
<li><code>proxy_connect_timeout</code></li>
</ol>
<p><code>proxy_connect_timeout time;</code><br>Defines a timeout for establishing a connection with a proxied server. It should be noted that this timeout cannot usually exceed 75 seconds<br>Default:    <code>proxy_connect_timeout 60s;</code><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_socket_keepalive</code></li>
</ol>
<p><code>proxy_socket_keepalive on | off;</code><br>Configures the “TCP keepalive” behavior for outgoing connections to a proxied server. By default, the operating system’s settings are in effect for the socket. If the directive is set to the value “on”, the SO_KEEPALIVE socket option is turned on for the socket.<br>Default:    <code>proxy_socket_keepalive off;</code><br>Context:    http, server, location</p>
<p>Note: there is a difference between HTTP KEEP-ALIVE and TCP KEEPALIVE.<br><a href="https://www.jianshu.com/p/cd71efa49d63">https://www.jianshu.com/p/cd71efa49d63</a></p>
<ol>
<li><code>proxy_send_timeout</code></li>
</ol>
<p><code>proxy_send_timeout time;</code><br>Sets a timeout for transmitting a request to the proxied server. The timeout is set only between two successive write operations, not for the transmission of the whole request. If the proxied server does not receive anything within this time, the connection is closed.<br>Default:    <code>proxy_send_timeout 60s;</code><br>Context:    http, server, location</p>
<ol>
<li><code>proxy_ignore_client_abort on | off;</code></li>
</ol>
<p><code>proxy_ignore_client_abort on | off;</code><br>Default:    <code>proxy_ignore_client_abort off;</code><br>Determines whether the connection with a proxied server should be closed when a client closes the connection without waiting for a response.<br>Context:    http, server, location</p>
<ul>
<li><strong>reference</strong><br><a href="https://nginx.org/en/docs/dirindex.html">https://nginx.org/en/docs/dirindex.html</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-15T18:56:00.000Z" title="2021-09-15T18:56:00.000Z">2021-09-15</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">2 minutes read (About 366 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/15/notes-of-nginx-learning-9/">notes of nginx learning (9)</a></h1><div class="content"><ul>
<li><strong>the category of nginx</strong></li>
</ul>
<ol>
<li>TCP connection variables;</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th>variable</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>$remote_addr</td>
<td>Client IP address</td>
</tr>
<tr>
<td>$remote_por</td>
<td>Client port</td>
</tr>
<tr>
<td>$server_addr</td>
<td>Server IP address</td>
</tr>
<tr>
<td>$server_port</td>
<td>Server Port</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>Server protocol</td>
</tr>
<tr>
<td>$binary_remote_addr</td>
<td>Client IP address in binary format</td>
</tr>
<tr>
<td>$connection</td>
<td>The serial number of the TCP connection, incremented</td>
</tr>
<tr>
<td>$connection_request</td>
<td>Number of current requests for TCP connection</td>
</tr>
<tr>
<td>$proxy_protocol_addr</td>
<td>If the proxy_protocol protocol is used, the address in the protocol is returned, otherwise it is null.</td>
</tr>
<tr>
<td>$proxy_protocol_port</td>
<td>If the proxy_protocol protocol is used, then the port in the protocol is returned, otherwise it returns null.</td>
</tr>
</tbody>
</table>
</div>
<ol>
<li>HTTP request variables;</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th>variable</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>$uri</td>
<td>The URL of the request, without parameters</td>
</tr>
<tr>
<td>$request_uri</td>
<td>URL of the request, with parameters</td>
</tr>
<tr>
<td>$request_method</td>
<td>request method</td>
</tr>
<tr>
<td>$request_length</td>
<td>The length of the request, including the request line, request header, and request body</td>
</tr>
<tr>
<td>$args</td>
<td>The full parameter string</td>
</tr>
<tr>
<td>$arg_<i>name</i></td>
<td>name Specific parameter value</td>
</tr>
<tr>
<td>$is_args</td>
<td>If the URL has arguments, return ?   otherwise returns null</td>
</tr>
<tr>
<td>$query_string</td>
<td>Same as args</td>
</tr>
<tr>
<td>$remote_user</td>
<td>The user name passed in by the HTTP Basic Authentication protocol</td>
</tr>
<tr>
<td>$host</td>
<td>First look at the request line, then look at the request header, and finally look for server_name</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>User browser</td>
</tr>
<tr>
<td>$http_referer</td>
<td>The link from which the request came</td>
</tr>
<tr>
<td>$http_via</td>
<td>Pass through a layer of proxy servers, add the information of the corresponding proxy server</td>
</tr>
<tr>
<td>$http_x_forwarded_for</td>
<td>Get the user’s real IP</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>user cookie</td>
</tr>
</tbody>
</table>
</div>
<ol>
<li>Variables generated by nginx processing of HTTP requests;</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th>variable</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>$request_time</td>
<td>The amount of time spent processing the request</td>
</tr>
<tr>
<td>$request_completion</td>
<td>Returns OK when the request is completed, otherwise returns null</td>
</tr>
<tr>
<td>$server_name</td>
<td>Match the server_name value of the request</td>
</tr>
<tr>
<td>$https</td>
<td>return on if https is enabled, otherwise return null</td>
</tr>
<tr>
<td>$request_filename</td>
<td>The full path to the file to be accessed on the disk file system</td>
</tr>
<tr>
<td>$document_root</td>
<td>The path to the folder generated by the URI and root/alias rules</td>
</tr>
<tr>
<td>$realpath_root</td>
<td>Replaces the soft link in document_root with the real path</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>Returns the speed limit at response time</td>
</tr>
</tbody>
</table>
</div>
<ol>
<li>nginx return response variables;</li>
<li>nginx internal variables;</li>
</ol>
<ul>
<li><strong>reference</strong><br><a href="https://www.cnblogs.com/xiongfanyong/articles/13928494.html">https://www.cnblogs.com/xiongfanyong/articles/13928494.html</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-07T06:59:00.000Z" title="2021-09-07T06:59:00.000Z">2021-09-07</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">12 minutes read (About 1749 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/07/notes-of-nginx-learning-7/">notes of nginx learning (7)</a></h1><div class="content"><ul>
<li><strong>Look into Module ngx_http_limit_conn_module</strong></li>
</ul>
<p>The <code>ngx_http_limit_conn_module</code> module is used to limit the number of connections per the defined key, in particular, the number of connections from a single IP address.<br>Not all connections are counted. A connection is counted only if it has a request being processed by the server and the whole request header has already been read.<br>In default, the nginx is compiled with <code>http_limit_conn_module</code> . If we don’t want that, we need to use <code>--without-http_limit_conn_module</code>.<br>This module uses shared memory for every worker process<br>Now, let’s look at commonly used directives.</p>
<ol>
<li><code>limit_conn_zone</code></li>
</ol>
<p><code>limit_conn_zone key zone=name:size;</code><br>Sets parameters for a shared memory zone that will keep states for various keys. In particular, the state includes the current number of connections. The key can contain text, variables, and their combination. Requests with an empty key value are not accounted.<br>Context:    http<br>For example:<br><code>limit_conn_zone $binary_remote_addr zone=addr:10m;</code><br>where <code>$binary_remote_addr</code> is the embedded variable which is  client address in a binary form, value’s length is always 4 bytes for IPv4 addresses or 16 bytes for IPv6 addresses</p>
<ol>
<li><code>limit_conn_status</code></li>
</ol>
<p><code>limit_conn_status code;</code><br>Sets the status code to return in response to rejected requests.<br>Default:    <code>limit_conn_status 503;</code><br>Context:    http, server, location</p>
<ol>
<li><code>limit_conn_log_level info</code></li>
</ol>
<p><code>limit_conn_log_level info | notice | warn | error;</code><br>Sets the desired logging level for cases when the server limits the number of connections.<br>Default:    <code>limit_conn_log_level error;</code><br>Context:    http, server, location</p>
<ol>
<li><code>limit_conn</code></li>
</ol>
<p><code>limit_conn zone number;</code><br>Sets the shared memory zone and the maximum allowed number of connections for a given key value. When this limit is exceeded, the server will return the error in reply to a request<br>Context:http, server, location<br>For example,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone $binary_remote_addr zone&#x3D;addr:10m;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location &#x2F;download&#x2F; &#123;</span><br><span class="line">        limit_conn addr 1;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>allow only one connection per an IP address at a time.</p>
<p>Another example<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone $binary_remote_addr zone&#x3D;perip:10m;</span><br><span class="line">limit_conn_zone $server_name zone&#x3D;perserver:10m;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    limit_conn perip 10;</span><br><span class="line">    limit_conn perserver 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>There could be several limit_conn directives. the below configuration will limit the number of connections to the server per a client IP and, at the same time, the total number of connections to the virtual server.</p>
<p>Another directive we might use is <code>limit_rate</code>, even though it is not in the <code>http_limit_conn_module</code>, it is in the core module.</p>
<p><code>limit_rate rate;</code><br>Limits the rate of response transmission to a client. The rate is specified in bytes per second. The zero value disables rate limiting. The limit is set per a request, and so if a client simultaneously opens two connections, the overall rate will be twice as much as the specified limit.<br>Context:    http, server, location, if in location<br>Default:    <code>limit_rate 0;</code><br>Parameter value can contain variables (1.17.0). It may be useful in cases where rate should be limited depending on a certain condition:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map $slow $rate &#123;</span><br><span class="line">    1     4k;</span><br><span class="line">    2     8k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">limit_rate $rate;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Look into Modulengx_http_limit_req_module</strong><br>The ngx_http_limit_req_module module  is used to limit the request processing rate per a defined key, in particular, the processing rate of requests coming from a single IP address.<br>In default, the nginx is compiled with <code>http_http_limit_req_module</code> . If we don’t want that, we need to use <code>--without-http_limit_req_module</code>.<br>This module uses shared memory for every worker process<br>Now, let’s look at commonly used directives.<br>The limitation is done using the <strong>leaky bucket</strong> method.<br>Suppose we have a bucket in which we are pouring water in a random order but we have to get water in a fixed rate, for this we will make a hole at the bottom of the bucket. It will ensure that water coming out is in a some fixed rate, and also if bucket will full we will stop pouring in it.<br>The input rate can vary, but the output rate remains constant. Similarly, in networking, a technique called leaky bucket can smooth out bursty traffic. Bursty chunks are stored in the bucket and sent out at an average rate.<br>Now, let’s look at commonly used directives.</li>
</ul>
<ol>
<li><code>limit_req_zone</code></li>
</ol>
<p>Sets parameters for a shared memory zone that will keep states for various keys. In particular, the state stores the current number of excessive requests. The key can contain text, variables, and their combination. Requests with an empty key value are not accounted.<br><code>limit_req_zone key zone=name:size rate=rate [sync];</code></p>
<p>Here is an example<br><code>limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</code><br>Here, the states are kept in a 10 megabyte zone “one”, and an average request processing rate for this zone cannot exceed 1 request per second.</p>
<ol>
<li><code>limit_req_status</code></li>
</ol>
<p><code>limit_req_status code;</code><br>Sets the status code to return in response to rejected requests.<br>Default:    <code>limit_req_status 503;</code><br>Context:    http, server, location</p>
<ol>
<li><code>limit_req_log_level</code></li>
</ol>
<p><code>limit_req_log_level info | notice | warn | error;</code><br>Sets the desired logging level for cases when the server refuses to process requests due to rate exceeding, or delays request processing. Logging level for delays is one point less than for refusals; for example, if “limit_req_log_level notice” is specified, delays are logged with the info level.<br>Default:    <code>limit_req_log_level error;</code><br>Context:    http, server, location</p>
<ol>
<li><code>limit_req</code></li>
</ol>
<p><code>limit_req zone=name [burst=number] [nodelay | delay=number];</code></p>
<p>Sets the shared memory zone and the maximum burst size of requests. If the requests rate exceeds the rate configured for a zone, their processing is delayed such that requests are processed at a defined rate. Excessive requests are delayed until their number exceeds the maximum burst size in which case the request is terminated with an error. By default, the maximum burst size is equal to zero.</p>
<p>Here is an example<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone&#x3D;one:10m rate&#x3D;1r&#x2F;s;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    location &#x2F;search&#x2F; &#123;</span><br><span class="line">        limit_req zone&#x3D;one burst&#x3D;5;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>allow not more than 1 request per second at an average, with bursts not exceeding 5 requests.</p>
<ul>
<li><strong>the diff of http_limit_conn_module and http_limit_req_module</strong></li>
</ul>
<p>http_limit_conn_module focus on TCP connection while http_limit_req_module focus on http requests.</p>
<ul>
<li><strong>Look into Module ngx_http_access_module</strong></li>
</ul>
<p>The ngx_http_access_module module allows limiting access to certain client addresses.<br>In default, the nginx is compiled with <code>http_access_module</code> . If we don’t want that, we need to use <code>--without-http_access_module</code>.</p>
<p>Access can also be limited by password(Module ngx_http_auth_basic_module), by the result of subrequest(ngx_http_auth_request_module), or by JWT(ngx_http_auth_jwt_module). Simultaneous limitation of access by address and by password is controlled by the satisfy directive.</p>
<p>Here are some directives.</p>
<ol>
<li><code>allow</code></li>
</ol>
<p><code>allow address | CIDR | unix: | all;</code><br>Allows access for the specified network or address. If the special value unix: is specified (1.5.1), allows access for all UNIX-domain sockets.<br>Context:    http, server, location, limit_except<br>CIDR is Classless Inter-Domain Routing. eg:<code>198.51.100.0/22</code><br>example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">allow 192.168.1.0</span><br><span class="line">allow 192.168.1.0&#x2F;24;</span><br><span class="line">allow 10.1.1.0&#x2F;16;</span><br><span class="line">allow 2001:0db8::&#x2F;32;</span><br></pre></td></tr></table></figure></p>
<p><code>deny address | CIDR | unix: | all;</code><br>Denies access for the specified network or address. If the special value unix: is specified (1.5.1), denies access for all UNIX-domain sockets.<br>Context:    http, server, location, limit_except<br>Denies access for the specified network or address. If the special value unix: is specified (1.5.1), denies access for all UNIX-domain sockets.<br>example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deny  192.168.1.1;</span><br><span class="line">deny  all;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>Look into Module ngx_http_auth_basic_module</strong></li>
</ul>
<p>The ngx_http_auth_basic_module module allows limiting access to resources by validating the user name and password using the “HTTP Basic Authentication” protocol.</p>
<p>In default, the nginx is compiled with <code>http_auth_basic_module</code> . If we don’t want that, we need to use <code>--without-http_auth_basic_module</code>.</p>
<p>Here are some directives.</p>
<ol>
<li><code>auth_basic</code></li>
</ol>
<p><code>auth_basic string | off;</code><br>Enables validation of user name and password using the “HTTP Basic Authentication” protocol. The string can be custom and  will be displayed in the pop-up window</p>
<ol>
<li><code>auth_basic_user_file</code></li>
</ol>
<p><code>auth_basic_user_file file;</code><br>Specifies a file that keeps user names and passwords, in the following format:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># comment</span><br><span class="line">name1:password1</span><br><span class="line">name2:password2:comment</span><br><span class="line">name3:password3</span><br></pre></td></tr></table></figure><br>Since in most cases, the password stored has been encrypted. We could use package <code>htpasswd</code>. For convenience, I use online tool <a href="https://hostingcanada.org/htpasswd-generator/">https://hostingcanada.org/htpasswd-generator/</a> and store the value in  <code>/usr/local/nginx/auth/.htpasswd</code>.</p>
<p>Then we could modify the <code>nginx.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">    root   html&#x2F;servername_1;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    auth_basic &quot;test username and password&quot;;</span><br><span class="line">    auth_basic_user_file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;auth&#x2F;.htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Under this circumstance, when we visit <code>localhost</code>, it pop up a log in window to request me input username and password. If our input can match the record in <code>.htpasswd</code>, it will show the page.</p>
<ul>
<li><strong>Look into  ngx_http_auth_request_module</strong></li>
</ul>
<p>The ngx_http_auth_request_module module (1.5.4+) implements client authorization based on the result of a subrequest. If the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403, the access is denied with the corresponding error code. Any other response code returned by the subrequest is considered an error.</p>
<p>The work mechanism looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                response</span><br><span class="line">    &lt;------------------------------------------------</span><br><span class="line">                                                    |</span><br><span class="line">        request                          if 2XX     |</span><br><span class="line">client ----------&gt;Authentication Server;----------&gt;Server</span><br><span class="line">                      |</span><br><span class="line">      if not 2xx      |</span><br><span class="line">      like 4xx        |         </span><br><span class="line">  &lt;--------------------</span><br></pre></td></tr></table></figure><br>In default, the nginx is compiled with <code>http_auth_request_module</code> . If we  want that, we need to use <code>--with-http_auth_request_module</code>.</p>
<p>Let us look at some directives</p>
<ol>
<li><code>auth_request</code></li>
</ol>
<p><code>auth_request uri | off;</code><br>Enables authorization based on the result of a subrequest and sets the URI to which the subrequest will be sent.<br>Default:    <code>auth_request off;</code><br>Context:    http, server, location<br>Here is an example<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;private&#x2F; &#123;</span><br><span class="line">    auth_request &#x2F;auth;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x3D; &#x2F;auth &#123;</span><br><span class="line">    proxy_pass ...</span><br><span class="line">    proxy_pass_request_body off;</span><br><span class="line">    proxy_set_header Content-Length &quot;&quot;;</span><br><span class="line">    proxy_set_header X-Original-URI $request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>If the <code>/auth</code> return with status code 2XX, then the request will be sent to <code>/private</code>. If not, it will directly return to client.</p>
<ol>
<li><code>auth_request_set</code></li>
</ol>
<p><code>auth_request_set $variable value;</code><br>Sets the request variable to the given value after the authorization request completes. The value may contain variables from the authorization request, such as <code>$upstream_http_*</code>.<br>Context:    http, server, location</p>
<p>refer:<br><a href="https://nginx.org/en/docs/">https://nginx.org/en/docs/</a><br><a href="https://www.geeksforgeeks.org/leaky-bucket-algorithm/">https://www.geeksforgeeks.org/leaky-bucket-algorithm/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-07T06:52:00.000Z" title="2021-09-07T06:52:00.000Z">2021-09-07</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">9 minutes read (About 1394 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/07/notes-of-nginx-learning-6/">notes of nginx learning (6)</a></h1><div class="content"><ul>
<li><strong>common directives in main block</strong></li>
</ul>
<ol>
<li><code>user</code><br><code>user [user] [group];</code><br>Specify users and user groups that can run nginx services<br>Comment  the user directive, or configure it to nobody so that all users can run it<br>example:<br><code>user nobody nobody;</code><br><br/></li>
<li><code>pid</code><br><code>pid file;</code><br>Defines a file that will store the process ID of the main process.<br>example:<br><code>pid logs/nginx.pid</code><br><br/></li>
<li><code>worker_rlimit_nofile</code><br><code>worker_rlimit_nofile number;</code><br>Changes the limit on the maximum number of open files (RLIMIT_NOFILE) for worker processes. Used to increase the limit without restarting the main process.<br><br/></li>
<li><code>worker_rlimit_core</code><br><code>worker_rlimit_core size;</code><br>Changes the limit on the largest size of a core file (RLIMIT_CORE) for worker processes. Used to increase the limit without restarting the main process.<br><br/></li>
<li><code>worker_processes</code><br><code>worker_processes number | auto;</code><br>The optimal value depends on many factors including (but not limited to) the number of CPU cores, the number of hard disk drives that store data, and load pattern. When one is in doubt, setting it to the number of available CPU cores would be a good start (the value “auto” will try to autodetect it).<br><br/></li>
<li><code>worker_cpu_affinity</code><br><code>worker_cpu_affinity cpumask ...;</code><br><code>worker_cpu_affinity auto [cpumask];</code><br>Binds worker processes to the sets of CPUs. Each CPU set is represented by a bitmask of allowed CPUs. There should be a separate set defined for each of the worker processes. By default, worker processes are not bound to any specific CPUs.<br>example: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  4;  </span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br></pre></td></tr></table></figure>
binds each worker process to a separate CPU,<br><br/></li>
<li><code>worker_priority</code><br><code>worker_processes number | auto;</code><br>Defines the number of worker processes.<br><br/></li>
<li><code>worker_shutdown_timeout</code><br><code>worker_shutdown_timeout time;</code><br>Configures a timeout for a graceful shutdown of worker processes. When the time expires, nginx will try to close all the connections currently open to facilitate shutdown.<br><br/></li>
<li><code>timer_resolution</code><br><code>timer_resolution interval;</code><br>Reduces timer resolution in worker processes, thus reducing the number of <code>gettimeofday()</code>system calls made. By default,<code>gettimeofday()</code> is called each time a kernel event is received. With reduced resolution, <code>gettimeofday()</code> is only called once per specified interval.<br>example:<br><code>timer_resolution 100ms;</code><br><br/></li>
<li><code>daemon</code><br><code>daemon on | off;</code><br>Determines whether nginx should become a daemon. Mainly used during development.<br><br></li>
<li><code>lock_file</code><br><code>lock_file file;</code><br>nginx uses the locking mechanism to implement accept_mutex and serialize access to shared memory. On most systems the locks are implemented using atomic operations, and this directive is ignored. On other systems the “lock file” mechanism is used. This directive specifies a prefix for the names of lock files.<br>example:<br><code>lock_file logs/nginx.lock;</code><br><br></li>
</ol>
<ul>
<li><strong>common directives in event block</strong></li>
</ul>
<ol>
<li><code>use</code><br><code>use method;</code><br>Specifies the connection processing method to use. There is normally no need to specify it explicitly, because nginx will by default use the most efficient method.<br><br></li>
<li><code>worker_connections</code><br><code>worker_connections number;</code><br>Sets the maximum number of simultaneous connections that can be opened by a worker process.<br><br></li>
<li><code>accept_mutex</code><br><code>accept_mutex on | off;</code><br>When only one request arrives at a given moment, multiple sleeping processes are woken up at the same time, but only one process can get a connection. If the number of processes waking up at a time is too large, this can affect some of the system performance. This can be a problem with multiple processes on an Nginx server.If accept_mutex is enabled, worker processes will accept new connections by turn. Otherwise, all worker processes will be notified about new connections.<br>The  default value is on<br><br></li>
<li><p><code>accept_mutex_delay</code><br><code>accept_mutex_delay time;</code><br>If accept_mutex is enabled, specifies the maximum time during which a worker process will try to restart accepting new connections if another worker process is currently accepting new connections.<br><br></p>
</li>
<li><p><code>multi_accept</code><br><code>multi_accept on | off;</code><br>If multi_accept is disabled, a worker process will accept one new connection at a time. Otherwise, a worker process will accept all new connections at a time.</p>
</li>
</ol>
<ul>
<li><strong>other directives in location block</strong></li>
</ul>
<ol>
<li><p>the diff of <code>root</code> and <code>alias</code></p>
<p> <code>root path;</code><br> Sets the root directory for requests.</p>
<p> <code>alias path;</code><br> Defines a replacement for the specified location.</p>
<p> The diff of two directives can be seen：</p>
<ol>
<li>root context:http, server, location, if in location while alias context:location</li>
<li>for root no need to end with <code>/</code>, for alias, must end with <code>/</code></li>
<li><p>path</p>
<p> if the setting for root is</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;picture&#123;</span><br><span class="line">  root &#x2F;opt&#x2F;nginx&#x2F;html&#x2F;picture</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p> if we request a picture <code>wwww.test.com/picture/1.jpg</code>,we will find the picture in <code>/opt/nginx/html/picture/picture/1.jpg</code></p>
<p> if the setting for alias is</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;picture&#123;</span><br><span class="line">  alias &#x2F;opt&#x2F;nginx&#x2F;html&#x2F;picture</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p> if we request a picture <code>wwww.test.com/picture/1.jpg</code>,we will find the picture in <code>/opt/nginx/html/picture/1.jpg</code></p>
</li>
</ol>
</li>
</ol>
<ul>
<li><strong>the usage of location</strong></li>
</ul>
<p><code>location [ = | ~ | ~* | ^~ ] uri { ... }</code><br><code>location @name { ... }</code><br>Sets configuration depending on a request URI.<br>The matching is performed against a normalized URI, after decoding the text encoded in the “%XX” form, resolving references to relative path components “.” and “..”, and possible compression of two or more adjacent slashes into a single slash.<br>Nginx location block section have a search order, a modifier, an implicit match type and an implicit switch to whether stop the search on match or not. the following array describe it for regex.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Nginx location:</span><br><span class="line"># --------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"># Search-Order       Modifier       Description                                                        Match-Type        Stops-search-on-match</span><br><span class="line"># --------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">#     1st               &#x3D;           The URI must match the specified pattern exactly                  Simple-string              Yes</span><br><span class="line">#     2nd               ^~          The URI must begin with the specified pattern                     Simple-string              Yes</span><br><span class="line">#     3rd             (None)        The URI must begin with the specified pattern                     Simple-string               No</span><br><span class="line">#     4th               ~           The URI must be a case-sensitive match to the specified Rx      Perl-Compatible-Rx      Yes (first match)                 </span><br><span class="line">#     4th               ~*          The URI must be a case-insensitive match to the specified Rx    Perl-Compatible-Rx      Yes (first match)</span><br><span class="line">#     N&#x2F;A               @           Defines a named location block.                                   Simple-string              Yes</span><br><span class="line"># --------------------------------------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>And here is  pseudo-code from <a href="https://github.com/detailyang/nginx-location-match-visible">https://github.com/detailyang/nginx-location-match-visible</a> to help understand the order</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">match</span><span class="params">(uri)</span>:</span></span><br><span class="line">  rv = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> uri <span class="keyword">in</span> exact_match:</span><br><span class="line">    <span class="keyword">return</span> exact_match[uri]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> uri <span class="keyword">in</span> prefix_match:</span><br><span class="line">    <span class="keyword">if</span> prefix_match[uri] <span class="keyword">is</span> <span class="string">'^~'</span>:</span><br><span class="line">      <span class="keyword">return</span> prefix_match[uri]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      rv = prefix_match[uri]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> uri <span class="keyword">in</span> regex_match:</span><br><span class="line">    <span class="keyword">return</span> regex_match[uri]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<p>Note that there is a difference between path ends with <code>/</code> and path ends without <code>/</code><br>For example, we have two similar location blocks<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># location block 1</span><br><span class="line">location &#x2F;test &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># location block 2</span><br><span class="line">location &#x2F;test&#x2F;&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>For the first location block, it will first find file in the path <code>/test/index.html</code>(It will treat <code>/test</code> as directory). If cannot find, it will  find the file in the path <code>/test</code>(It will treat <code>/test</code> as file).<br>For the first location block, it will first find file in the path <code>/test/index.html</code>(It will treat <code>/test</code> as directory). If cannot find, it will return 404 rather than treating  <code>/test</code> as file.</p>
<ul>
<li><strong>the usage of stub_status</strong></li>
</ul>
<ol>
<li>If we want to use directive <code>stub_status</code>, we need to recompile our nginx with it.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure  --with-zlib&#x3D;..&#x2F;zlib-1.2.11 --with-pcre&#x3D;..&#x2F;pcre-8.45 --with-openssl&#x3D;..&#x2F;openssl-1.1.1l --with-http_stub_status_module</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>If not, we will face error <code>unknown directive &quot;stub_status&quot;</code></p>
<ol>
<li><p>we need to modify the <code>nginx.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;stub_status &#123;</span><br><span class="line">    stub_status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The context of stub_status:    server, location<br>Also, we need to reload the configuration.</p>
</li>
<li><p>use stub_status</p>
</li>
</ol>
<p><code>stub_status</code> will make basic status information will be accessible from the surrounding location.<br>In that case, we could visit <code>www.nginx_test1.com/stub_status</code> (we set the server_name is <code>www.nginx_test1.com</code>)<br>And the page look like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 1</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 2 2 4</span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0</span><br></pre></td></tr></table></figure></p>
<p>It contains following status information</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>status information</th>
<th>details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Active connections</td>
<td>The current number of active client connections including Waiting connections.</td>
</tr>
<tr>
<td>accepts</td>
<td>The total number of accepted client connections.</td>
</tr>
<tr>
<td>handled</td>
<td>The total number of handled connections. Generally, the parameter value is the same as accepts unless some resource limits have been reached (for example, the worker_connections limit).</td>
</tr>
<tr>
<td>requests</td>
<td>The total number of client requests.</td>
</tr>
<tr>
<td>Reading</td>
<td>The current number of connections where nginx is reading the request header.</td>
</tr>
<tr>
<td>Writing</td>
<td>The current number of connections where nginx is writing the response back to the client.</td>
</tr>
<tr>
<td>Waiting</td>
<td>The current number of idle client connections waiting for a request</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><strong>refer</strong></li>
</ul>
<p><a href="https://stackoverflow.com/questions/59846238/guide-on-how-to-use-regex-in-nginx-location-block-section">https://stackoverflow.com/questions/59846238/guide-on-how-to-use-regex-in-nginx-location-block-section</a><br><a href="https://github.com/detailyang/nginx-location-match-visible">https://github.com/detailyang/nginx-location-match-visible</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-02T01:25:00.000Z" title="2021-09-02T01:25:00.000Z">2021-09-01</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">7 minutes read (About 1006 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/01/notes-of-nginx-learning-4/">notes of nginx learning (4)</a></h1><div class="content"><ul>
<li><strong>Configuration parameters for Nginx compilation and installation</strong></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>parameter</th>
<th>meaning</th>
<th>default value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>–prefix=*path*</code></td>
<td>Specify the installation directory</td>
<td><code>/usr/local/nginx</code></td>
</tr>
<tr>
<td><code>–sbin-path=*path*</code></td>
<td>sets the name of an NGINX executable file. This name is used only during installation.</td>
<td><code>prefix/sbin/nginx.</code></td>
</tr>
<tr>
<td><code>–conf-path=*path*</code></td>
<td>sets the name of an nginx.conf configuration file</td>
<td><code>prefix/conf/nginx.conf</code></td>
</tr>
<tr>
<td><code>–pid-path=*path*</code></td>
<td>sets the name of an nginx.pid file that will store the process ID of the main process.</td>
<td><code>prefix/logs/nginx.pid</code></td>
</tr>
<tr>
<td><code>–error-log-path=*path*</code></td>
<td>sets the name of the primary error, warnings, and diagnostic file.</td>
<td><code>prefix/logs/error.log.</code></td>
</tr>
<tr>
<td><code>–http-log-path=*path*</code></td>
<td>sets the name of the primary request log file of the HTTP server.</td>
<td><code>prefix/logs/access.log</code></td>
</tr>
<tr>
<td><code>–user=*name*</code></td>
<td>sets the name of an unprivileged user whose credentials will be used by worker processes.</td>
<td>nobody</td>
</tr>
<tr>
<td><code>–group=*name*</code></td>
<td>sets the name of a group whose credentials will be used by worker processes.</td>
<td>a group name is set to the name of an unprivileged user</td>
</tr>
<tr>
<td><code>–with-pcre=*path*</code></td>
<td>sets the path to the sources of the PCRE library. The library is required for regular expressions support in the location directive and for the ngx_http_rewrite_module.</td>
<td></td>
</tr>
<tr>
<td><code>–with-zlib=*path*</code></td>
<td>sets the path to the sources of the zlib library.The library is required for the ngx_http_gzip_module.</td>
</tr>
</tbody>
</table>
</div>
<p>The parameter <code>--with-$module</code> is to add the module when compiling while <code>--without-$module</code> is compiling without that module. The default situation is without.</p>
<ul>
<li><strong>Install and configure nginx in Mac os</strong></li>
</ul>
<ol>
<li>Download the source package<br>Nginx <a href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a><br>zlib <a href="http://zlib.net/">http://zlib.net/</a><br>pcre <a href="http://www.pcre.org/">http://www.pcre.org/</a><br>openssl <a href="https://www.openssl.org/source/">https://www.openssl.org/source/</a></li>
</ol>
<p>note: for pcre, we don’t use pcre2. Otherwise, we will meet the error <code>src/core/ngx_regex.h:15:10: fatal error: &#39;pcre.h&#39; file not found</code></p>
<ol>
<li><p>unzip the package</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf nginx-1.21.1.tar.gz</span><br><span class="line">tar xf pcre-8.45.tar.gz</span><br><span class="line">tar xf zlib-1.2.11.tar.gz</span><br><span class="line">tar xf openssl-1.1.1l.tar.gz</span><br></pre></td></tr></table></figure>
<p>Now we can see the configuration file <code>nginx-1.21.1/</code><br>And to see the parameters of configuration we could</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.21.1.tar.gz</span><br><span class="line">.&#x2F;configure --help</span><br></pre></td></tr></table></figure>
<p>understand the configure script<br><a href="https://en.wikipedia.org/wiki/Configure_script">https://en.wikipedia.org/wiki/Configure_script</a></p>
</li>
<li><p>compile and install Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure  --with-zlib&#x3D;..&#x2F;zlib-1.2.11 --with-pcre&#x3D;..&#x2F;pcre-8.45 --with-openssl&#x3D;..&#x2F;openssl-1.1.1l</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>And we see the configuration summary like that<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Configuration summary</span><br><span class="line">  + using PCRE library: ..&#x2F;pcre-8.45</span><br><span class="line">  + using OpenSSL library: ..&#x2F;openssl-1.1.1l</span><br><span class="line">  + using zlib library: ..&#x2F;zlib-1.2.11</span><br><span class="line"></span><br><span class="line">  nginx path prefix: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&quot;</span><br><span class="line">  nginx binary file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx&quot;</span><br><span class="line">  nginx modules path: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;modules&quot;</span><br><span class="line">  nginx configuration prefix: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&quot;</span><br><span class="line">  nginx configuration file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf&quot;</span><br><span class="line">  nginx pid file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&quot;</span><br><span class="line">  nginx error log file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;error.log&quot;</span><br><span class="line">  nginx http access log file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log&quot;</span><br><span class="line">  nginx http client request body temporary files: &quot;client_body_temp&quot;</span><br><span class="line">  nginx http proxy temporary files: &quot;proxy_temp&quot;</span><br><span class="line">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</span><br><span class="line">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</span><br><span class="line">  nginx http scgi temporary files: &quot;scgi_temp&quot;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>Run nginx<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br></pre></td></tr></table></figure>
Check whether the nginx is successfully started by accessing 127.0.0.1<br>And also we can use <code>ps -ef| grep nginx</code></li>
</ol>
<p>And we could see other command of nginx by <code>sudo  /usr/local/nginx/sbin/nginx -h</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line">  -?,-h         : this help</span><br><span class="line">  -v            : show version and exit</span><br><span class="line">  -V            : show version and configure options then exit</span><br><span class="line">  -t            : test configuration and exit</span><br><span class="line">  -T            : test configuration, dump it and exit</span><br><span class="line">  -q            : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : set prefix path (default: &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;)</span><br><span class="line">  -e filename   : set error log file (default: logs&#x2F;error.log)</span><br><span class="line">  -c filename   : set configuration file (default: conf&#x2F;nginx.conf)</span><br><span class="line">  -g directives : set global directives out of configuration file</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>the structure of configuration file</strong><br>we could find the configuration file in <code>/usr/local/nginx/conf/nginx.conf</code></li>
</ul>
<p>The structure of configuration file can be seen as</p>
<ul>
<li><p>main block<br>Configure directives that affect nginx globally. Generally there are user groups running the nginx server, nginx process pid storage paths, log storage paths,importing configuration file , number of worker processes allowed to be generated, etc.</p>
</li>
<li><p>event block<br>Configure the network connections that affect the nginx server or the user. There is a maximum number of connections per process, which event-driven model to pick to handle connection requests, whether to allow multiple network connections to be accepted at the same time, enable serialization of multiple network connections, etc.</p>
</li>
<li><p>http block<br>You can nest multiple server blocks, configure most of the features such as proxy, cache, log definition and third-party module configuration. Such as file introduction, mime-type definition, log customization, whether to use sendfile to transfer files, connection timeout, number of single connection requests, etc.</p>
<ul>
<li>server block<br>Configure virtual host parameters.<br>Each http block can contain multiple server blocks, and each server block is equivalent to a virtual host, which can have multiple hosts jointly providing services, together with a set of services that are logically close to each other externally.</li>
</ul>
</li>
</ul>
<ul>
<li>location block<br>Configure the routing of requests and the processing of various pages</li>
</ul>
<p><br/></p>
<ul>
<li><strong>modify the nginx.conf</strong></li>
</ul>
<p>We could see user permission of nginx.conf by <code>ls -ll</code><br>And to modify it, we need <code>sudo emacs nginx.conf</code></p>
<p>To make nginx.conf take effect, we need to reload it by<br><code>sudo /usr/local/nginx/sbin/nginx  -s reload</code></p>
<p>To check the grammer of the config file we could <code>sudo /usr/local/nginx/sbin/nginx -t</code></p>
<ul>
<li><strong>refer</strong></li>
</ul>
<p><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/installoptions/">https://www.nginx.com/resources/wiki/start/topics/tutorials/installoptions/</a><br><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#:~:text=Nginx%E7%9A%84%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6,%E9%97%B4%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%AC%A1%E5%BA%8F%E5%85%B3%E7%B3%BB%E3%80%82">https://www.cnblogs.com/54chensongxia/p/12938929.html#:~:text=Nginx%E7%9A%84%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6,%E9%97%B4%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%AC%A1%E5%BA%8F%E5%85%B3%E7%B3%BB%E3%80%82</a><br><a href="http://nginx.org/en/docs/ngx_core_module.html">http://nginx.org/en/docs/ngx_core_module.html</a><br><a href="https://nginx.org/en/docs/dirindex.html">https://nginx.org/en/docs/dirindex.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-09-02T01:11:00.000Z" title="2021-09-02T01:11:00.000Z">2021-09-01</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">a few seconds read (About 66 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/09/01/notes-of-nginx-learning-3/">notes of nginx learning (3)</a></h1><div class="content"><ul>
<li><p><strong>Nginx modular design</strong><br>High cohesion and low coupling</p>
</li>
<li><p><strong>modular structure</strong></p>
<ul>
<li>core modular<ul>
<li>ngx_core</li>
<li>ngx_errlog</li>
<li>ngx_conf</li>
<li>ngx_events</li>
<li>ngx_epoll</li>
<li>ngx_regex</li>
<li>ngx_event   </li>
</ul>
</li>
<li><p>standard http modular</p>
<ul>
<li>ngx_http_core</li>
<li>ngx_http_charset</li>
<li>others</li>
</ul>
</li>
<li><p>optional http modular</p>
<ul>
<li>ngx_http_gzip</li>
<li>ngx_http_ssl</li>
<li>others</li>
</ul>
</li>
<li><p>mail service modular</p>
<ul>
<li>ngx_mail_core</li>
<li>ngx_mail_pop3</li>
<li>others</li>
</ul>
</li>
<li>third-party service modular<ul>
<li>rds_json_nginx</li>
<li>lua_nginx</li>
<li>others</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-08-24T16:30:00.000Z" title="2021-08-24T16:30:00.000Z">2021-08-24</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">4 minutes read (About 549 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/08/24/notes-of-nginx-learning-2/">notes of nginx learning (2)</a></h1><div class="content"><ul>
<li><p><strong>multprocess vs multithread</strong><br>multithread Shared address space</p>
</li>
<li><p><strong>why nginx use mutliprocess rather than vsmultithread</strong><br>need robustness，if one thread ruin the address space, it will ruin the entire multithread program</p>
</li>
<li><p><strong>structure chart of nginx process</strong></p>
</li>
</ul>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">master process  </span><br><span class="line">           cache  manager (CM)</span><br><span class="line">           cache loader(CL)</span><br><span class="line">           worker process 1</span><br><span class="line">           worker process 2</span><br><span class="line">           worker process 3</span><br><span class="line">           ...</span><br></pre></td></tr></table></figure>
<ul>
<li>master process doesn’t  actually handle users’ requests It only manager the monitor the child processes. This design is good for hot deployment.</li>
<li>when developing third-party module, it is better not modify the master process. Because if we cause error in the master process, it will influence the whole nginx.</li>
<li>The communication between the child processes is through shared memory</li>
</ul>
<ul>
<li><strong>Which process can be managed through semaphore</strong> <ul>
<li>master process <ul>
<li>monitor worker process (CHLD)</li>
<li>manage worker process </li>
<li>receive semaphore(TERM,INT,HUP,USE1,USE2,WINCH)</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>semophore</th>
<th>command line</th>
<th>fuction</th>
</tr>
</thead>
<tbody>
<tr>
<td>QUIT</td>
<td><code>kill -3 $pid</code> or <code>kill -s SIGQUIT $pid</code></td>
<td>graceful shutdown</td>
</tr>
<tr>
<td>TERM, INT</td>
<td><code>kill -15 $pid</code></td>
<td>fast shutdown</td>
</tr>
<tr>
<td>HUP</td>
<td><code>kill -1 $pid</code></td>
<td>changing configuration, keeping up with a changed time zone (only for FreeBSD and Linux), starting new worker processes with a new configuration, graceful shutdown of old worker processes</td>
</tr>
<tr>
<td>USR1</td>
<td><code>kill -10 $pid</code></td>
<td>re-opening log files</td>
</tr>
<tr>
<td>USR2</td>
<td><code>kill -12 $pid</code></td>
<td>upgrading an executable file</td>
</tr>
<tr>
<td>WINCH</td>
<td><code>kill -28 $pid</code></td>
<td>graceful shutdown of worker processes</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>worker process<ul>
<li>receive semaphore(TERM,INT,HUP,USE1,USE2,WINCH)</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>semophore</th>
<th>command line</th>
<th>fuction</th>
</tr>
</thead>
<tbody>
<tr>
<td>TERM, INT</td>
<td><code>kill -15 $pid</code></td>
<td>fast shutdown</td>
</tr>
<tr>
<td>QUIT</td>
<td><code>kill -3 $pid</code></td>
<td>graceful shutdown</td>
</tr>
<tr>
<td>HUP</td>
<td><code>kill -1 $pid</code></td>
<td>changing configuration, keeping up with a changed time zone (only for FreeBSD and Linux), starting new worker processes with a new configuration, graceful shutdown of old worker processes</td>
</tr>
<tr>
<td>USR1</td>
<td><code>kill -10 $pid</code></td>
<td>re-opening log files</td>
</tr>
<tr>
<td>USR2</td>
<td><code>kill -12 $pid</code></td>
<td>upgrading an executable file</td>
</tr>
<tr>
<td>WINCH</td>
<td><code>kill -28 $pid</code></td>
<td>abnormal termination for debugging (requires debug_points to be enabled)</td>
</tr>
</tbody>
</table>
</div>
<pre><code>- It is not recommended. Because the master process will monitor all the worker process, if one worker process receive the SIGNTERM semaphore, even though this worker process will shut down, the master process will recreate a new worker process
</code></pre><ul>
<li>commend line <ul>
<li>reload (HUP)</li>
<li>reopen(USE1)</li>
<li>stop(TERM)</li>
<li>quit(QUIT)<br>example:<br><code>nginx -s reload</code><br>It is the same as send semaphore to master process</li>
</ul>
</li>
</ul>
<ul>
<li><strong>reload process in semaphore</strong><ol>
<li>Send HUP semaphore or use reload in command line</li>
<li>Check if the syntax of the configuration file is correct</li>
<li>master process will open new listening port </li>
<li>master process will use the new configuration to generate new worker process(It is possible that old and new exists at the same time)</li>
<li>master process sends the quit semaphore to previous worker process</li>
<li>The old worker process will process the work task and disconnect and quit</li>
</ol>
</li>
</ul>
<ul>
<li><strong>the process of hot upgrading</strong><ol>
<li>replace old nginx file to new nginx file （not change the directory)</li>
<li>send USR2 signal to master process</li>
<li>master process modify the pid file by adding suffix <code>.oldbin</code></li>
<li>master process uses new nginx file to start a new master process<br>(we need to verify that the new master process works well )</li>
<li>sends WINCH signal to  old master make old work processes shut down. It will make the new request go to the new master </li>
<li>ROLLBACK situation: (if the new master process not work) Send HUB signal to old master while sending QUIT to new master</li>
</ol>
</li>
</ul>
<p>-<strong>REFER</strong></p>
<p>course:<a href="https://coding.imooc.com/class/chapter/405.html#Anchor">https://coding.imooc.com/class/chapter/405.html#Anchor</a><br><a href="https://en.wikipedia.org/wiki/Signal_(IPC">https://en.wikipedia.org/wiki/Signal_(IPC</a>)</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2021-08-23T17:42:00.000Z" title="2021-08-23T17:42:00.000Z">2021-08-23</time><span class="level-item"> lawiet019 </span><span class="level-item"><a class="link-muted" href="/categories/technology/">technology</a></span><span class="level-item">a minute read (About 217 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/08/23/notes-of-nginx-learning-1/">notes of  nginx learning (1)</a></h1><div class="content"><ul>
<li><p><strong>what is nginx</strong><br>NGINX is open source software for web serving, reverse proxying, caching, load balancing, media streaming, and more. It started out as a web server designed for maximum performance and stability. In addition to its HTTP server capabilities, NGINX can also function as a proxy server for email (IMAP, POP3, and SMTP) and a reverse proxy and load balancer for HTTP, TCP, and UDP servers.<br>main purpose:</p>
<ul>
<li>High performance static server</li>
<li>reverse proxy<br>what is reverse proxy <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">      http request         </span><br><span class="line">client ------------&gt; nginx --------&gt;http server </span><br><span class="line">       &lt;------------       &lt;--------</span><br><span class="line">                            http response </span><br><span class="line">      imcp&#x2F;pop</span><br><span class="line">      request          </span><br><span class="line">client ------------&gt; nginx --------&gt;mail server </span><br><span class="line">       &lt;------------       &lt;--------</span><br><span class="line">                            imcp&#x2F;pop </span><br><span class="line">                            response</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>why we need nginx</strong></p>
<ul>
<li>Data volume grow, single-core cpu to multicore cpu</li>
<li>Apache is inefficient in processing requests（ not suitable for concurrency,multi-core cpu)</li>
</ul>
</li>
<li><p><strong>Apache vs Nginx</strong> </p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>Apache</th>
<th>Nginx</th>
</tr>
</thead>
<tbody>
<tr>
<td>one process handles one request</td>
<td>one process handles multiple request</td>
</tr>
<tr>
<td>blocking</td>
<td>non-blocking</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p><strong>Common application scenarios</strong> </p>
<ul>
<li>static resources<br>Provide services through the local file system</li>
<li>reverse proxying （handle dynamic resources)<ul>
<li>high performance of nginx </li>
<li>Cache acceleration</li>
<li>Load Balance</li>
</ul>
</li>
<li>API service<br>OpenResty</li>
</ul>
</li>
<li><p><strong>Advantages of Nginx</strong></p>
<ul>
<li>High concurrency and high performance</li>
<li>Good scalability,Low coupling.</li>
<li>asynchronous non-blocking event-driven model</li>
<li>high reliability</li>
<li>Business continuity（no need to shut down the machine to update the resources)</li>
<li>Allow secondary development</li>
</ul>
</li>
</ul>
<p>course:<a href="https://coding.imooc.com/class/chapter/405.html#Anchor">https://coding.imooc.com/class/chapter/405.html#Anchor</a></p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/img/avatar.jpeg" alt="koko"></figure><p class="title is-size-4 is-block line-height-inherit">koko</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Troy, NY</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">39</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">22</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/lawiet019" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/lawiet019"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/math/"><span class="level-start"><span class="level-item">math</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/technology/"><span class="level-start"><span class="level-item">technology</span></span><span class="level-end"><span class="level-item tag">33</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/technology/math/"><span class="level-start"><span class="level-item">math</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">Recent</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-15T19:03:00.000Z">2021-09-15</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/15/notes-of-nginx-learning-11/">notes of nginx learning (11)</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/technology/">technology</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-15T19:00:00.000Z">2021-09-15</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/15/notes-of-nginx-learning-10/">notes of nginx learning (10)</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/technology/">technology</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-15T18:56:00.000Z">2021-09-15</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/15/notes-of-nginx-learning-9/">notes of nginx learning (9)</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/technology/">technology</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-07T07:00:58.000Z">2021-09-07</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/07/notes-of-nginx-learning-8/">notes of nginx learning (8)</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-07T06:59:00.000Z">2021-09-07</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/07/notes-of-nginx-learning-7/">notes of nginx learning (7)</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/technology/">technology</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2021/09/"><span class="level-start"><span class="level-item">September 2021</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/08/"><span class="level-start"><span class="level-item">August 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C++</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Graph/"><span class="tag">Graph</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/algorithm/"><span class="tag">algorithm</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/binary-search/"><span class="tag">binary search</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bit-manipulation/"><span class="tag">bit manipulation</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/collections/"><span class="tag">collections</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/computing/"><span class="tag">computing</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/debug/"><span class="tag">debug</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dynamic-programming/"><span class="tag">dynamic programming</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/graph/"><span class="tag">graph</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/learning-note/"><span class="tag">learning note</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linked-list/"><span class="tag">linked list</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/multiprocess/"><span class="tag">multiprocess</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/multithread/"><span class="tag">multithread</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag is-grey-lightest">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regular-expression/"><span class="tag">regular expression</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sort/"><span class="tag">sort</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sorting/"><span class="tag">sorting</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tool/"><span class="tag">tool</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tree/"><span class="tag">tree</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe to Updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="lawilet&#039;s website" height="28"></a><p class="size-small"><span>&copy; 2021 lawiet019</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://law-liet.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>